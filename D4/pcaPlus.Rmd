---
title: "Complete PCA Analysis (Multiple Axes)"
author: "Analysis"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: yes
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, 
                      fig.width=10, fig.height=7) 
# Default fig height/width, will adjust for square plots
```

### 1. Load, Prepare, and Run PCA

This single chunk loads the data and runs the `prcomp` function to create **all** the objects we need for all plots.

```{r load-and-run-pca}
# 1. Load data
dd <- read.csv("ifood_enriched.csv", header=T, sep=",")

# 2. Define our variable lists
active_num_vars <- c(
    'Income', 'Age', 'Recency', 'CustDays', 'WineExp', 'FruitExp', 'MeatExp', 
    'FishExp', 'SweetExp', 'GoldExp', 'DealsPurc', 'WebPurc', 'CatalogPurc', 'StorePurc'
)

illu_quali_vars <- c(
    'Education', 'MaritalSts', 'Kidhome', 'Teenhome', 'CustomerSegment', 
    'IncomeSegment', 'PreferredProductCategory', 'PreferredChannel', 'HasChildren'
)

# 3. Handle missing data
dd <- dd[complete.cases(dd[, active_num_vars]), ]

# 4. Create the data frame of ACTIVE continuous variables
dcon <- dd[, active_num_vars]

# 5. Convert illustrative variables to factors
for (col in illu_quali_vars) {
  dd[[col]] <- as.factor(dd[[col]])
}

# 6. Run PCA
acp <- prcomp(dcon, scale = TRUE)

# 7. Get all PCA objects
valprop <- acp$sdev^2            # Eigenvalues (Inertia)
percent_inertia <- (valprop / sum(valprop)) * 100
cumulative_inertia <- cumsum(percent_inertia)
Psi <- acp$x                     # Principal Components (Individuals)
rot <- acp$rotation               # Loadings (Variables)

# 8. Create Eigenvalue table
eig_table <- data.frame(
  Eigenvalue = valprop,
  "Represented_Inertia_%" = percent_inertia,
  "Cummulated_Inertia_%" = cumulative_inertia
)
print("Inertia Table:")
print(head(eig_table))

# Define colors for qualitative plots (consistent across maps)
qual_colors <- rainbow(length(illu_quali_vars))
```

---

### 2. Inertia Plots

These are the two inertia plots.

#### a. Subspace Represented Inertia

**Output: `represented_inertia_plot.pdf`**

```{r plot-represented-inertia}
# --- 1. Start PDF Output ---
pdf("represented_inertia_plot.pdf", width = 10, height = 7)

# --- 2. Set margins ---
par(mar=c(5, 4.5, 4, 1)) 

# --- 3. Create the Plot ---
bp <- barplot(percent_inertia,
        main="Subspace Represented Inertia (% Variance)",
        xlab="Principal Component",
        ylab="% of Inertia Explained",
        names.arg=NULL, 
        ylim=c(0, max(percent_inertia) * 1.1), 
        col="skyblue", 
        border=NA,
        xaxt="n" 
        )

# --- 4. Add details ---
grid(ny=NULL, nx=NA, col="grey", lty="dotted")
barplot(percent_inertia, add=TRUE, col="skyblue", border=NA, xaxt="n")
text(x=bp, y=percent_inertia + max(percent_inertia)*0.02, 
     labels=sprintf("%.1f", percent_inertia), 
     cex=0.8)
axis(1, at=bp, labels=paste0("PC", 1:length(percent_inertia)), 
     las=2, cex.axis=0.9)
box()

# --- 5. Close the PDF file ---
dev.off()
```

#### b. Subspace Cummulated Represented Inertia

**Output: `cummulated_inertia_plot.pdf`**

```{r plot-cummulated-inertia}
# --- 1. Start PDF Output ---
pdf("cummulated_inertia_plot.pdf", width = 10, height = 7)

# --- 2. Set margins ---
par(mar=c(5, 4.5, 4, 2)) 

# --- 3. Create the Plot ---
bp <- barplot(cumulative_inertia,
        main="Subspace Cummulated Represented Inertia",
        xlab="Principal Component",
        ylab="Cumulative % of Inertia Explained",
        names.arg=NULL, 
        ylim=c(0, 105), 
        col="skyblue",
        border=NA,
        xaxt="n" 
        )

# --- 4. Add details ---
grid(ny=NULL, nx=NA, col="grey", lty="dotted")
barplot(cumulative_inertia, add=TRUE, col="skyblue", border=NA, xaxt="n")
abline(h=80, col="red", lty=2, lwd=2)
text(x=bp, y=cumulative_inertia + 3, 
     labels=sprintf("%.1f", cumulative_inertia), 
     cex=0.8)
axis(1, at=bp, labels=paste0("PC", 1:length(cumulative_inertia)), 
     las=2, cex.axis=0.9)
legend("bottomright", 
       legend="80% Cumulative Inertia", 
       lty=2, col="red", lwd=2, bg="white", box.lty=0, cex=0.9, inset=c(0.02, 0.05)) 
box()

# --- 5. Close the PDF file ---
dev.off()
```

---

### 3. Factorial Map Visualisation (Axes 1-4)

Here we plot the three maps (Individuals, Numerical, Qualitative) for each combination of the first four axes.

#### Axes 1 vs 2

```{r maps-1-2, fig.width=10, fig.height=8}
eje1 <- 1
eje2 <- 2
axis_label = "1_2"

# --- Individuals ---
pdf(paste0("individuals_map_", axis_label, ".pdf"), width = 10, height = 8)
fator_color <- dd$CustomerSegment
plot(Psi[, eje1], Psi[, eje2],
     main=paste("Individuals Map (Axes", eje1, "vs", eje2, ") Colored by CustomerSegment"),
     xlab=paste0("PC", eje1, " (", round(eig_table[eje1, 2], 1), "%)"),
     ylab=paste0("PC", eje2, " (", round(eig_table[eje2, 2], 1), "%)"),
     pch=16, col=as.numeric(fator_color)) 
legend("bottomright", levels(fator_color), pch=16, col=1:length(levels(fator_color)), cex=0.8, title="Customer Segment")
dev.off()

# --- Numerical Variables ---
pdf(paste0("numerical_variables_map_", axis_label, ".pdf"), width = 10, height = 10)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(0, 0, type="n", xlim=c(-1,1), ylim=c(-1,1),
     main=paste("Numerical Variables (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2), asp=1) 
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
symbols(0, 0, circles=1, inches=FALSE, add=TRUE, lty=2, col="grey")
arrows(0, 0, rot[, eje1], rot[, eje2], col="red", length=0.1)
text(rot[, eje1]*1.1, rot[, eje2]*1.1, labels=rownames(rot), col="red", cex=0.7)
dev.off()

# --- Qualitative Variables ---
pdf(paste0("qualitative_modalities_map_", axis_label, ".pdf"), width = 10, height = 8)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(Psi[, eje1], Psi[, eje2], type="n",
     main=paste("Qualitative Modalities (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2))
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
c <- 1
for (k in illu_quali_vars) {
  fator <- as.factor(dd[, k])
  fdic1 <- tapply(Psi[, eje1], fator, mean)
  fdic2 <- tapply(Psi[, eje2], fator, mean)
  text(fdic1, fdic2, labels=names(fdic1), col=qual_colors[c], cex=0.8, font=2)
  c <- c + 1
}
legend("topleft", illu_quali_vars, text.col=qual_colors, bty="n", cex=0.8)
dev.off()
```

#### Axes 1 vs 3

```{r maps-1-3, fig.width=10, fig.height=8}
eje1 <- 1
eje2 <- 3
axis_label = "1_3"

# --- Individuals ---
pdf(paste0("individuals_map_", axis_label, ".pdf"), width = 10, height = 8)
fator_color <- dd$CustomerSegment
plot(Psi[, eje1], Psi[, eje2],
     main=paste("Individuals Map (Axes", eje1, "vs", eje2, ") Colored by CustomerSegment"),
     xlab=paste0("PC", eje1, " (", round(eig_table[eje1, 2], 1), "%)"),
     ylab=paste0("PC", eje2, " (", round(eig_table[eje2, 2], 1), "%)"),
     pch=16, col=as.numeric(fator_color)) 
legend("bottomright", levels(fator_color), pch=16, col=1:length(levels(fator_color)), cex=0.8, title="Customer Segment")
dev.off()

# --- Numerical Variables ---
pdf(paste0("numerical_variables_map_", axis_label, ".pdf"), width = 10, height = 10)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(0, 0, type="n", xlim=c(-1,1), ylim=c(-1,1),
     main=paste("Numerical Variables (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2), asp=1) 
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
symbols(0, 0, circles=1, inches=FALSE, add=TRUE, lty=2, col="grey")
arrows(0, 0, rot[, eje1], rot[, eje2], col="red", length=0.1)
text(rot[, eje1]*1.1, rot[, eje2]*1.1, labels=rownames(rot), col="red", cex=0.7)
dev.off()

# --- Qualitative Variables ---
pdf(paste0("qualitative_modalities_map_", axis_label, ".pdf"), width = 10, height = 8)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(Psi[, eje1], Psi[, eje2], type="n",
     main=paste("Qualitative Modalities (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2))
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
c <- 1
for (k in illu_quali_vars) {
  fator <- as.factor(dd[, k])
  fdic1 <- tapply(Psi[, eje1], fator, mean)
  fdic2 <- tapply(Psi[, eje2], fator, mean)
  text(fdic1, fdic2, labels=names(fdic1), col=qual_colors[c], cex=0.8, font=2)
  c <- c + 1
}
legend("topleft", illu_quali_vars, text.col=qual_colors, bty="n", cex=0.8)
dev.off()
```

#### Axes 1 vs 4

```{r maps-1-4, fig.width=10, fig.height=8}
eje1 <- 1
eje2 <- 4
axis_label = "1_4"

# --- Individuals ---
pdf(paste0("individuals_map_", axis_label, ".pdf"), width = 10, height = 8)
fator_color <- dd$CustomerSegment
plot(Psi[, eje1], Psi[, eje2],
     main=paste("Individuals Map (Axes", eje1, "vs", eje2, ") Colored by CustomerSegment"),
     xlab=paste0("PC", eje1, " (", round(eig_table[eje1, 2], 1), "%)"),
     ylab=paste0("PC", eje2, " (", round(eig_table[eje2, 2], 1), "%)"),
     pch=16, col=as.numeric(fator_color)) 
legend("bottomright", levels(fator_color), pch=16, col=1:length(levels(fator_color)), cex=0.8, title="Customer Segment")
dev.off()

# --- Numerical Variables ---
pdf(paste0("numerical_variables_map_", axis_label, ".pdf"), width = 10, height = 10)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(0, 0, type="n", xlim=c(-1,1), ylim=c(-1,1),
     main=paste("Numerical Variables (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2), asp=1) 
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
symbols(0, 0, circles=1, inches=FALSE, add=TRUE, lty=2, col="grey")
arrows(0, 0, rot[, eje1], rot[, eje2], col="red", length=0.1)
text(rot[, eje1]*1.1, rot[, eje2]*1.1, labels=rownames(rot), col="red", cex=0.7)
dev.off()

# --- Qualitative Variables ---
pdf(paste0("qualitative_modalities_map_", axis_label, ".pdf"), width = 10, height = 8)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(Psi[, eje1], Psi[, eje2], type="n",
     main=paste("Qualitative Modalities (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2))
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
c <- 1
for (k in illu_quali_vars) {
  fator <- as.factor(dd[, k])
  fdic1 <- tapply(Psi[, eje1], fator, mean)
  fdic2 <- tapply(Psi[, eje2], fator, mean)
  text(fdic1, fdic2, labels=names(fdic1), col=qual_colors[c], cex=0.8, font=2)
  c <- c + 1
}
legend("topleft", illu_quali_vars, text.col=qual_colors, bty="n", cex=0.8)
dev.off()
```

#### Axes 2 vs 3

```{r maps-2-3, fig.width=10, fig.height=8}
eje1 <- 2
eje2 <- 3
axis_label = "2_3"

# --- Individuals ---
pdf(paste0("individuals_map_", axis_label, ".pdf"), width = 10, height = 8)
fator_color <- dd$CustomerSegment
plot(Psi[, eje1], Psi[, eje2],
     main=paste("Individuals Map (Axes", eje1, "vs", eje2, ") Colored by CustomerSegment"),
     xlab=paste0("PC", eje1, " (", round(eig_table[eje1, 2], 1), "%)"),
     ylab=paste0("PC", eje2, " (", round(eig_table[eje2, 2], 1), "%)"),
     pch=16, col=as.numeric(fator_color)) 
legend("bottomright", levels(fator_color), pch=16, col=1:length(levels(fator_color)), cex=0.8, title="Customer Segment")
dev.off()

# --- Numerical Variables ---
pdf(paste0("numerical_variables_map_", axis_label, ".pdf"), width = 10, height = 10)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(0, 0, type="n", xlim=c(-1,1), ylim=c(-1,1),
     main=paste("Numerical Variables (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2), asp=1) 
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
symbols(0, 0, circles=1, inches=FALSE, add=TRUE, lty=2, col="grey")
arrows(0, 0, rot[, eje1], rot[, eje2], col="red", length=0.1)
text(rot[, eje1]*1.1, rot[, eje2]*1.1, labels=rownames(rot), col="red", cex=0.7)
dev.off()

# --- Qualitative Variables ---
pdf(paste0("qualitative_modalities_map_", axis_label, ".pdf"), width = 10, height = 8)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(Psi[, eje1], Psi[, eje2], type="n",
     main=paste("Qualitative Modalities (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2))
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
c <- 1
for (k in illu_quali_vars) {
  fator <- as.factor(dd[, k])
  fdic1 <- tapply(Psi[, eje1], fator, mean)
  fdic2 <- tapply(Psi[, eje2], fator, mean)
  text(fdic1, fdic2, labels=names(fdic1), col=qual_colors[c], cex=0.8, font=2)
  c <- c + 1
}
legend("topleft", illu_quali_vars, text.col=qual_colors, bty="n", cex=0.8)
dev.off()
```

#### Axes 2 vs 4

```{r maps-2-4, fig.width=10, fig.height=8}
eje1 <- 2
eje2 <- 4
axis_label = "2_4"

# --- Individuals ---
pdf(paste0("individuals_map_", axis_label, ".pdf"), width = 10, height = 8)
fator_color <- dd$CustomerSegment
plot(Psi[, eje1], Psi[, eje2],
     main=paste("Individuals Map (Axes", eje1, "vs", eje2, ") Colored by CustomerSegment"),
     xlab=paste0("PC", eje1, " (", round(eig_table[eje1, 2], 1), "%)"),
     ylab=paste0("PC", eje2, " (", round(eig_table[eje2, 2], 1), "%)"),
     pch=16, col=as.numeric(fator_color)) 
legend("bottomright", levels(fator_color), pch=16, col=1:length(levels(fator_color)), cex=0.8, title="Customer Segment")
dev.off()

# --- Numerical Variables ---
pdf(paste0("numerical_variables_map_", axis_label, ".pdf"), width = 10, height = 10)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(0, 0, type="n", xlim=c(-1,1), ylim=c(-1,1),
     main=paste("Numerical Variables (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2), asp=1) 
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
symbols(0, 0, circles=1, inches=FALSE, add=TRUE, lty=2, col="grey")
arrows(0, 0, rot[, eje1], rot[, eje2], col="red", length=0.1)
text(rot[, eje1]*1.1, rot[, eje2]*1.1, labels=rownames(rot), col="red", cex=0.7)
dev.off()

# --- Qualitative Variables ---
pdf(paste0("qualitative_modalities_map_", axis_label, ".pdf"), width = 10, height = 8)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(Psi[, eje1], Psi[, eje2], type="n",
     main=paste("Qualitative Modalities (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2))
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
c <- 1
for (k in illu_quali_vars) {
  fator <- as.factor(dd[, k])
  fdic1 <- tapply(Psi[, eje1], fator, mean)
  fdic2 <- tapply(Psi[, eje2], fator, mean)
  text(fdic1, fdic2, labels=names(fdic1), col=qual_colors[c], cex=0.8, font=2)
  c <- c + 1
}
legend("topleft", illu_quali_vars, text.col=qual_colors, bty="n", cex=0.8)
dev.off()
```

#### Axes 3 vs 4

```{r maps-3-4, fig.width=10, fig.height=8}
eje1 <- 3
eje2 <- 4
axis_label = "3_4"

# --- Individuals ---
pdf(paste0("individuals_map_", axis_label, ".pdf"), width = 10, height = 8)
fator_color <- dd$CustomerSegment
plot(Psi[, eje1], Psi[, eje2],
     main=paste("Individuals Map (Axes", eje1, "vs", eje2, ") Colored by CustomerSegment"),
     xlab=paste0("PC", eje1, " (", round(eig_table[eje1, 2], 1), "%)"),
     ylab=paste0("PC", eje2, " (", round(eig_table[eje2, 2], 1), "%)"),
     pch=16, col=as.numeric(fator_color)) 
legend("bottomright", levels(fator_color), pch=16, col=1:length(levels(fator_color)), cex=0.8, title="Customer Segment")
dev.off()

# --- Numerical Variables ---
pdf(paste0("numerical_variables_map_", axis_label, ".pdf"), width = 10, height = 10)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(0, 0, type="n", xlim=c(-1,1), ylim=c(-1,1),
     main=paste("Numerical Variables (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2), asp=1) 
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
symbols(0, 0, circles=1, inches=FALSE, add=TRUE, lty=2, col="grey")
arrows(0, 0, rot[, eje1], rot[, eje2], col="red", length=0.1)
text(rot[, eje1]*1.1, rot[, eje2]*1.1, labels=rownames(rot), col="red", cex=0.7)
dev.off()

# --- Qualitative Variables ---
pdf(paste0("qualitative_modalities_map_", axis_label, ".pdf"), width = 10, height = 8)
par(mar=c(5.1, 4.1, 4.1, 2.1)) # Reset margins
plot(Psi[, eje1], Psi[, eje2], type="n",
     main=paste("Qualitative Modalities (Axes", eje1, "vs", eje2, ")"),
     xlab=paste0("PC", eje1), ylab=paste0("PC", eje2))
abline(h=0, lty=2, col="grey"); abline(v=0, lty=2, col="grey")
c <- 1
for (k in illu_quali_vars) {
  fator <- as.factor(dd[, k])
  fdic1 <- tapply(Psi[, eje1], fator, mean)
  fdic2 <- tapply(Psi[, eje2], fator, mean)
  text(fdic1, fdic2, labels=names(fdic1), col=qual_colors[c], cex=0.8, font=2)
  c <- c + 1
}
legend("topleft", illu_quali_vars, text.col=qual_colors, bty="n", cex=0.8)
dev.off()
```

---

### 4. Interpretation of Relationships (Axes 1 & 2)

**Note:** The primary interpretation typically focuses on the first two axes as they explain the most variance. Interpretations for other axes (e.g., PC3, PC4) can be derived by examining their corresponding variable maps if specific secondary patterns are of interest.

#### Interpretation of Axis 1 (PC1: 37.5% Variance)

Dimension 1 is the horizontal axis.

* **What drives it?** This axis is defined by **spending, income, and customer value**.
    * **Numerical:** All "Expense" variables (`WineExp`, `MeatExp`, `FruitExp`, etc.) and purchasing channels (`CatalogPurc`, `StorePurc`, `WebPurc`) point strongly to the **right**. `Income` also points strongly to the right.
    * **Qualitative:** The centroids for `High` (IncomeSegment) and `CustomerSegment 2` are far to the **right**. The centroids for `Low` (IncomeSegment) and `Segments 1 & 3` are far to the **left**. The `Kidhome 1` centroid is also on the **left**, while `Kidhome 0` is on the **right**.

* **Latent Variable (Conclusion):**
    * **Dimension 1 represents a "Customer Value" axis.**
    * **Positive Side (Right):** This is the **High-Value Customer**. They have a high `Income`, spend heavily, and are in `CustomerSegment 2`. They are also less likely to have young children (`Kidhome 0`).
    * **Negative Side (Left):** This is the **Low-Value Customer**. They have `Low` income, belong to `Segment 1` or `3`, and are more likely to have a child (`Kidhome 1`).

#### Interpretation of Axis 2 (PC2: 10.6% Variance)

Dimension 2 is the vertical axis.

* **What drives it?** This axis is defined by **shopping behavior and lifestage**.
    * **Numerical:** The *strongest* active variable is `DealsPurc`, which points straight **up**. `WebPurc` also points up.
    * **Qualitative:** The centroids for `Teenhome 1` and `Teenhome 2` are strongly positive (**top**). The preferred channels `DealsPurc` and `WebPurc` are also at the **top**. Conversely, `Teenhome 0` and `HasChildren 0` are at the **bottom**.

* **Latent Variable (Conclusion):**
    * **Dimension 2 represents a "Lifestage & Channel" axis.**
    * **Positive Side (Top):** This is the **Deal-Seeking, Web-Oriented Parent of Teens**. This customer shops online (`WebPurc`), is motivated by discounts (`DealsPurc`), and is very likely to have one or more teenagers at home.
    * **Negative Side (Bottom):** This is the **Established, No-Teens, Traditional Shopper**. This customer does *not* have children (`HasChildren 0`), does not have teens (`Teenhome 0`), and is associated with the `CatalogPurc` preferred category.
```
